---
import type { CollectionEntry } from "astro:content";
import { Icon } from "astro-icon/components";
import {
	extractYouTubeId,
	extractVimeoId,
	getYouTubeThumbnail,
	extractVimeoHash
} from "@/lib/video-helpers";

interface Props {
	work: CollectionEntry<"works">;
	showTitle?: boolean; // Whether to show the title below the video
}

const { work, showTitle = true } = Astro.props;

// Get video ID and thumbnail based on type
const videoType = work.data.videoType;
const videoUrl = work.data.videoUrl;

let videoId: string | null = null;
let vimeoHash: string | null = null;
let embedUrl: string = '';
let thumbnailUrl: string | null = null;

if (videoType === 'youtube') {
	videoId = extractYouTubeId(videoUrl);
	if (videoId) {
		thumbnailUrl = getYouTubeThumbnail(videoId);
		embedUrl = `https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1`;
	}
} else if (videoType === 'vimeo') {
	videoId = extractVimeoId(videoUrl);
	vimeoHash = extractVimeoHash(videoUrl);
	if (videoId) {
		embedUrl = `https://player.vimeo.com/video/${videoId}?title=0&byline=0&portrait=0`;
		if (vimeoHash) {
			embedUrl += `&h=${vimeoHash}`;
		}
	}
}
---

<div class="items-stretch flex-col justify-center relative flex work-card">
	<div
		class="work-item overflow-hidden rounded-3xl relative group cursor-pointer bg-neutral-200"
		data-video-type={videoType}
		data-video-id={videoId}
		data-vimeo-hash={vimeoHash}
		data-embed-url={embedUrl}
	>
		<!-- Aspect ratio container -->
		<div class="relative w-full" style="padding-bottom: 56.25%;">
			<!-- Play button overlay -->
			<div
				class="play-overlay absolute inset-0 z-20 flex items-center justify-center bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"
			>
				<div
					class="play-button text-black bg-white/90 backdrop-blur-sm rounded-full w-20 h-20 flex items-center justify-center"
				>
					<Icon
						name="iconamoon:player-play-fill"
						class="w-10 h-10 ml-1"
					/>
				</div>
			</div>

			<!-- YouTube Thumbnail (works better than iframe preview) -->
			{videoType === 'youtube' && thumbnailUrl && (
				<img
					src={thumbnailUrl}
					alt={work.data.title}
					class="thumbnail-img absolute inset-0 w-full h-full object-cover"
					loading="lazy"
				/>
			)}

			<!-- Vimeo Preview iframe (loads video poster) -->
			{videoType === 'vimeo' && embedUrl && (
				<iframe
					src={embedUrl}
					class="preview-iframe absolute inset-0 w-full h-full pointer-events-none"
					allow="fullscreen; picture-in-picture"
					loading="lazy"
					title={work.data.title}
				></iframe>
			)}

			<!-- Video container for active playback -->
			<div class="video-container absolute inset-0 w-full h-full z-10 hidden">
				<!-- iframe injected via JS on click -->
			</div>
		</div>
	</div>

	<div class="mt-4">
		<div class="items-center justify-start flex flex-row gap-4">
			<div class="relative items-start flex-col flex max-w-full">
				{showTitle && (
					<h3 class="text-xl md:text-2xl leading-tight font-medium">
						{work.data.title}
					</h3>
				)}
			</div>
		</div>
	</div>
</div>

<style>
	.work-item.playing .play-overlay {
		display: none;
	}

	.work-item.playing .thumbnail-img {
		display: none;
	}

	.work-item.playing .preview-iframe {
		display: none;
	}

	.work-item.playing .video-container {
		display: block !important;
	}

	.video-container {
		position: absolute;
		inset: 0;
		width: 100%;
		height: 100%;
	}

	.video-container iframe {
		position: absolute !important;
		top: 0 !important;
		left: 0 !important;
		width: 100% !important;
		height: 100% !important;
		border: none !important;
	}
</style>

<script>
	// Handle video play on click
	document.addEventListener('click', (e) => {
		const workItem = (e.target as HTMLElement).closest('.work-item');
		if (!workItem) return;

		// Don't play again if already playing
		if (workItem.classList.contains('playing')) return;

		const videoType = workItem.getAttribute('data-video-type');
		const videoId = workItem.getAttribute('data-video-id');
		const vimeoHash = workItem.getAttribute('data-vimeo-hash');
		const baseEmbedUrl = workItem.getAttribute('data-embed-url');

		if (!videoType || !videoId || !baseEmbedUrl) return;

		const videoContainer = workItem.querySelector('.video-container');
		if (!videoContainer) return;

		// Add autoplay to the embed URL
		let embedUrl = baseEmbedUrl;
		if (videoType === 'youtube') {
			embedUrl += '&autoplay=1';
		} else if (videoType === 'vimeo') {
			embedUrl += '&autoplay=1';
		}

		const iframe = document.createElement('iframe');
		iframe.src = embedUrl;
		iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen';
		iframe.allowFullscreen = true;
		iframe.title = 'Video player';
		// Ensure iframe fills the container
		iframe.style.position = 'absolute';
		iframe.style.top = '0';
		iframe.style.left = '0';
		iframe.style.width = '100%';
		iframe.style.height = '100%';
		iframe.style.border = 'none';
		videoContainer.innerHTML = '';
		videoContainer.appendChild(iframe);
		workItem.classList.add('playing');
	});
</script>
